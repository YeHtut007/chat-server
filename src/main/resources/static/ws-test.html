<!doctype html>
<meta charset="utf-8" />
<title>WS Test (JWT)</title>

<label>Conversation ID</label><br/>
<input id="conv" value="11111111-1111-1111-1111-111111111111" style="width:520px" /><br/>

<label>Message</label><br/>
<input id="msg" placeholder="message" style="width:520px" /><br/>

<label>JWT</label><br/>
<input id="token" placeholder="paste JWT here" style="width:520px" /><br/><br/>

<button id="connect">Connect</button>
<button id="send">Send</button>
<pre id="log" style="border:1px solid #ccc; padding:8px; height:240px; overflow:auto;"></pre>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
let stomp;

function log(t){ 
  const el = document.getElementById('log');
  el.textContent += t + '\n';
  el.scrollTop = el.scrollHeight;
}

document.getElementById('connect').onclick = () => {
  const convId = document.getElementById('conv').value.trim();
  const token  = document.getElementById('token').value.trim();
  if (!token) { log('ERROR: paste a JWT first.'); return; }

  const sock = new SockJS('https://chat-server-wot9.onrender.com/ws'); // SockJS endpoint
  stomp = Stomp.over(sock);
  stomp.debug = (s) => {}; // silence STOMP debug; comment out to see frames

  stomp.connect({ Authorization: 'Bearer ' + token }, () => {
    log('connected');
    const topic = '/topic/chat.' + convId;   // <-- per-conversation topic
    stomp.subscribe(topic, m => log('recv: ' + m.body));
  }, err => {
    console.error(err);
    log('connect error: ' + (err && err.toString ? err.toString() : err));
  });
};

document.getElementById('send').onclick = () => {
  if (!stomp || !stomp.connected) { log('ERROR: not connected'); return; }
  const convId = document.getElementById('conv').value.trim();
  const content = document.getElementById('msg').value;
  const body = { conversationId: convId, content };
  stomp.send('/app/send', {}, JSON.stringify(body));  // server @MessageMapping("/send")
  log('sent: ' + content);
};
</script>
